<html>
<head>
<title>MessageNode</title>
</head>
<body>

<CENTER>
  <FONT SIZE=5> <B> JSONTNode </B> </FONT>
</CENTER>

<p>
JSONTNode formats JSON payload and properties of JMS messages based on either a
simple JSON template filr or a set of JSON formatters.  There are three
outlinks, done for the formatted messages, failure for those messages failed
in the format process and nohit for those messages not belonging to any
predefined rulesets.
</p>
<img vspace=10 halign=center src="JSONTNode.jpg" />
<p>
JSONTNode contains a number of predefined rulesets.  These rulesets categorize
messages into non-overlapping groups.  Therefore, each rule defines a unique
message group.  The ruleset also defines a formatter and its formatting
parameters. Different groups may have different formatters or different format
parameters. Due to JMS specifications, you have to clear user properties before
resetting them on a readonly message. You can specify ResetOption in a ruleset
so that the message properties will be reset for modifications. Its value is 0
for no reset, 1 for optional reset and 2 for guaranteed reset.
</p>
<p>
Each ruleset may has a list of FormatterArgument for generic format. If it is
defined in a rule, it will be invoked before JSON formatters. By default,
a rule has JSONFormatter defined to format JSON payload. A JSONFormatter has a
list of format opertions with each containing JSONPath for specifying what to
be formatted in the JSON payload, Operation, DataType, Template, Substitution
and Selector. JSONTNode supports various opertions, such as get, set, parse,
merge, union, first, last, min, max, sort and uniq, etc. 
</p>
<p>
JSONTNode also supports a simple JSON template applied on the JSON payload.
The path to the template file is generated by URITemplate. Therefore, it
URITemplate is deinded in a ruleset, JSONTNode will invoke the template on
the incoming message for the path. Then it will load the template file and
caches the compiled template dynamically. You can set the TTL for each rule
so that its JSON templets will be removed automatically after the expirations.
For parameters, JSONTNode supports dynamic setting of parameters.  It means
you can reference properties of the message in your parameters.  JSONTNode
will retrieve the data from incoming message and set the parameters before
the format process.
</p>
<p>
JSONTNode also supports customized formatters via plugins. In this case, the
full ClassName of the plugin and its argument for constructor must be defined
in the ruleset. The contructor argument is defined in a Map of JSONFormatter.
JSONNode will pass the data to the plugin's constructor as an opaque object
during the instantiation of the plugin. The developers of the plugin formatter
are supposed to document the details of JSONFormatter. JSONTNode will load the
plugin and invokes the method to format the messages of the ruleset.
</p>
<p>
JSONTNode always adds an extra ruleset for the nohit messages. This nohit
ruleset is always the first ruleset with the id of 0. On the node level,
DisplayMask and StringProperty control the display result of outgoing messages.
</p>
<p>
You are free to choose any names for the three fixed outlinks.  But JSONTNode
always assumes the first outlink for done, the second for failure and the last
for nohit.
</p>

<p>
Apart from the common properties, there are three implementation specific
properties for JSONTNode.
<TABLE border=1>
<TR>
<TH> Property Name </TH> <TH>Data Type</TH> <TH> Requirement </TH> <TH> Description </TH> <TH> Examples </TH>
</TR>
<TR>
<TD> SessionTimeout </TD> <TD> integer </TD> <TD> optional </TD> <TD> timeout in sec for a session </TD> <TD> 3600 (default: 0) </TD>
</TR>
</TABLE>
</p>

<p>
The format process is invoked via the pre-defined rulesets. Therefore, the
configuration of the rulesets is critical to the operations of JSONTNode.
Here are complete properties of rulesets for JSONTNode.

<TABLE border=1>
<TR>
<TH> Property Name </TH> <TH>Data Type</TH> <TH> Requirement </TH> <TH> Description </TH> <TH> Examples </TH>
</TR>
<TR>
<TD> Name </TD> <TD> alphanumeric with no spaces </TD> <TD> mandatory </TD> <TD> name of the ruleset </TD> <TD> event </TD>
</TR>
<TR>
<TD> ResetOption </TD> <TD> integer </TD> <TD> optional </TD> <TD> option to reset properties </TD> <TD> 2 (default: 0) </TD>
</TR>
<TR>
<TD> URITemplate </TD> <TD> string </TD> <TD> optional </TD> <TD> template for the full path of the template file </TD> <TD> /opt/qbroker/templates/##TempName##.jtmp </TD>
</TR>
<TR>
<TD> URISubstitution </TD> <TD> string </TD> <TD> optional </TD> <TD> text substitution for the full path of the template file </TD> <TD> s/\.json$/\.jtmp/ </TD>
</TR>
<TR>
<TD> TimeToLive </TD> <TD> integer </TD> <TD> optional </TD> <TD> seconds to cache the json templates </TD> <TD> </TD>
</TR>
<TR>
<TD> Parameter </TD> <TD> map </TD> <TD> optional </TD> <TD> for setting json parameters from the messages </TD> <TD> see example </TD>
</TR>
<TR>
<TD> JSONFormatter </TD> <TD> list </TD> <TD> optional </TD> <TD> list of json format operations </TD> <TD> see example </TD>
</TR>
<TR>
<TD> ClassName </TD> <TD> alphanumeric with no spaces </TD> <TD> optional </TD> <TD> full classname of the plugin formatter </TD> <TD> </TD>
</TR>
<TR>
<TD> PreferredOutLink </TD> <TD> alphanumeric with no spaces </TD> <TD> mandatory for bypass only </TD> <TD> name of the preferred outlink </TD> <TD> bypass </TD>
</TR>
<TR>
<TD> FormatterArgument </TD> <TD> list </TD> <TD> optional </TD> <TD> list of post format operations </TD> <TD> see example </TD>
</TR>
<TR>
<TD> JMSPropertyGroup </TD> <TD> list </TD> <TD> optional </TD> <TD> list of pattern groups on properties to select messages </TD> <TD> see example </TD>
</TR>
<TR>
<TD> XJMSPropertyGroup </TD> <TD> list </TD> <TD> optional </TD> <TD> list of pattern groups on properties to exclude messages </TD> <TD> see example </TD>
</TR>
<TR>
<TD> PatternGroup </TD> <TD> list </TD> <TD> optional </TD> <TD> list of pattern groups on body to select messages </TD> <TD> see example </TD>
</TR>
<TR>
<TD> XPatternGroup </TD> <TD> list </TD> <TD> optional </TD> <TD> list of pattern groups on body to exclude messages </TD> <TD> see example </TD>
</TR>
<TR>
<TD> StringProperty </TD> <TD> map </TD> <TD> optional </TD> <TD> for setting the user properties on the messages </TD> <TD> see example </TD>
</TR>
</TABLE>
where Parameter specifies the parameters for the format process.
PreferredOutLink can be defined for bypass rulesets only.  In this case,
the messages of the group will not be formatted.  Here is an example for
the bypass ruleset:
<pre>
{
  ...
  "Ruleset": [{
    "Name": "bypass",
    "PreferredOutLink": "NOHIT",
    "JMSPropertyGroup": [{
      "JMSType": "^score$"
    }]
  }],
  ...
}
</pre>
where it routes the messages to the outlink of NOHIT.
</p>
<p>
Here is an example of the format ruleset.
<pre>
{
  ...
  "Ruleset": [{
    "Name": "tm",
    "JMSPropertyGroup": [{
      "JMSType": "."
    }],
    "URITemplate": "/opt/qbroker/templates/##JMSType##.jtmp",
    "TimeToLive": "7200",
    "Parameter": {
      "tc": "##RTC##",
      "tm": "##Millis##"
    }]
  }],
  ...
}
</pre>
where it expects that the message has defined the template name of the JSON
template file in its JMSType property.  The node will extract the data for
the two parameters and set them before the format.  Upon success, the message
body will contain the new content formatted from the JSON template.
</p>

<p>
Here is an example of JSONFormatter:
<pre>
{
  ...
  "Ruleset": [{
    "Name": "rb",
    "JMSPropertyGroup": [{
      "FileName": "\\.rb$"
    }],
    "ResetOption": "1",
    "JSONFormatter": [{
      "JSONPath": ".",
      "Operation": "remove",
      "DataType": "map",
      "Selector": "^_"
    }]
  }],
  ...
}
</pre>
where it removes all keys starting with "_" in the current json map and
creates the message properies on those removed data.
</p>

<p>
Here is an example of JSONTNode:
<pre>
{
  "Name": "node_jsont",
  "ClassName": "org.qbroker.node.JSONTNode",
  "Description": "format messages",
  "Operation": "format",
  "LinkName": "root",
  "Capacity": "6",
  "WaitTime": "50",
  "DisplayMask": "0",
  "Debug": "1",
  "SessioTimeout": "600",
  "Ruleset": [{
    "Name": "html",
    "JMSPropertyGroup": [{
      "JMSType": "."
    }],
    "URITemplate": "/opt/qbroker/templates/##JMSType##.jtmp",
    "TimeToLive": "3600"
  }],
  "OutLink": ["done", "failure", "nohit"]
}
</pre>
</p>

</body>
</html>
